<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https: http:;">
    <title>FlowHub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e2e;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .titlebar {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            -webkit-app-region: drag;
        }

        .titlebar-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .titlebar-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .titlebar-button {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .titlebar-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .titlebar-button.close:hover {
            background: #ef4444;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px 20px;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .header h1::before {
            content: 'âš¡';
            font-size: 24px;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            min-width: 200px;
            max-width: 500px;
            background: rgba(30, 30, 46, 0.95);
            border-right: 1px solid rgba(99, 102, 241, 0.2);
            padding: 0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .resizer {
            width: 5px;
            background: transparent;
            cursor: col-resize;
            z-index: 10;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .resizer.active {
            background: rgba(99, 102, 241, 0.8);
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(30, 30, 46, 0.95);
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            font-size: 13px;
        }

        .file-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .file-item.folder {
            color: #a5b4fc;
        }

        .file-item.file {
            color: #e0e0e0;
        }

        .file-item.active {
            background: rgba(99, 102, 241, 0.3);
            border-left: 3px solid #6366f1;
        }

        .file-action-button {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 4px;
            color: #c7d2fe;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-action-button:hover {
            background: rgba(99, 102, 241, 0.4);
            transform: scale(1.1);
        }

        .ai-thinking {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #f59e0b;
            padding: 6px 12px;
            border-radius: 4px;
            color: #fbbf24;
            font-size: 13px;
            font-weight: 500;
            animation: thinking-pulse 1.5s ease-in-out infinite;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .image-preview-container {
            display: none;
            padding: 8px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .inline-icon-button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.1);
            color: #c7d2fe;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inline-icon-button:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        .inline-icon-button:active {
            transform: scale(0.95);
        }

        .inline-icon-button.active {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            animation: stop-pulse 1s ease-in-out infinite;
        }

        .sidebar-actions {
            padding: 16px;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
        }

        .sidebar-settings {
            padding: 16px;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
        }

        .sidebar-button {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sidebar-button:last-child {
            margin-bottom: 0;
        }

        .sidebar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sidebar-button:active {
            transform: translateY(0);
        }

        .sidebar-button:not(.danger):not(.settings) {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .sidebar-button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .sidebar-button.settings {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        @keyframes stop-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #a5b4fc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .command-button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .command-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .command-button:active {
            transform: translateY(0);
        }

        .command-button::before {
            content: 'â–¶';
            font-size: 12px;
            opacity: 0.8;
        }

        .copy-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .copy-button:active {
            transform: translateY(0);
        }

        .open-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .open-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        .open-button:active {
            transform: translateY(0);
        }

        .right-panel {
            width: 400px;
            min-width: 200px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            background: rgba(30, 30, 46, 0.95);
            border-left: 1px solid rgba(99, 102, 241, 0.2);
            overflow: hidden;
            flex-shrink: 0;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: rgba(30, 30, 46, 0.95);
        }

        .editor-header {
            background: linear-gradient(90deg, #312e81 0%, #4338ca 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .editor-title {
            font-size: 16px;
            font-weight: 600;
            color: #c7d2fe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .editor-title::before {
            content: 'ğŸ“';
        }

        .editor-status {
            background: rgba(99, 102, 241, 0.1);
            padding: 8px 16px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            font-size: 12px;
        }

        .editor-status {
            background: rgba(99, 102, 241, 0.1);
            padding: 8px 16px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            font-size: 12px;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
            padding: 16px;
        }

        .code-editor {
            width: 100%;
            height: 100%;
            background: #1a1a2a;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 16px;
            color: #d1d5db;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            overflow-y: auto;
        }

        .code-editor:focus {
            border-color: #818cf8;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }

        .code-editor::placeholder {
            color: #6b7280;
        }

        .save-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .save-button:active {
            transform: translateY(0);
        }

        .terminal-container {
            flex: 1;
            background: rgba(30, 30, 46, 0.95);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-header {
            background: linear-gradient(90deg, #312e81 0%, #4338ca 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .terminal-title {
            font-size: 16px;
            font-weight: 600;
            color: #c7d2fe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-title::before {
            content: 'ğŸ’»';
        }

        .terminal-output {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #d1d5db;
            background: #1a1a2a;
        }

        .output-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .output-line.command {
            color: #34d399;
            font-weight: 600;
        }

        .output-line.error {
            color: #f87171;
        }

        .output-line.success {
            color: #60a5fa;
        }

        .output-line.info {
            color: #a5b4fc;
        }

        .terminal-input-container {
            background: #282840;
            padding: 15px 20px;
            border-top: 2px solid rgba(99, 102, 241, 0.3);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .terminal-input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .terminal-input {
            flex: 1;
            background: rgba(30, 30, 46, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            padding-right: 140px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .terminal-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .terminal-input::placeholder {
            color: #6b7280;
        }

        .inline-tools-right {
            position: absolute;
            right: 12px;
            bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            pointer-events: none;
        }

        .inline-tools-right > * {
            pointer-events: auto;
        }

        .image-preview-inline {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .image-preview-inline-item {
            position: relative;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: #1a1a2a;
            flex-shrink: 0;
        }

        .image-preview-inline-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .image-preview-inline-item .delete-btn-inline {
            position: absolute;
            top: -4px;
            right: -4px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }

        .image-preview-inline-item .delete-btn-inline:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .inline-icon-button {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.1);
            color: #c7d2fe;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inline-icon-button:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        .inline-icon-button:active {
            transform: scale(0.95);
        }

        .inline-icon-button.active {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            animation: stop-pulse 1s ease-in-out infinite;
        }
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item-inline .delete-btn-inline {
            position: absolute;
            top: -4px;
            right: -4px;
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 1);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }

        .image-preview-item-inline .delete-btn-inline:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        .terminal-input {
            flex: 1;
            background: rgba(30, 30, 46, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .terminal-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .terminal-input::placeholder {
            color: #6b7280;
        }

        .execute-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .execute-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .execute-button:active {
            transform: translateY(0);
        }

        .terminal-input-container > div:last-child {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .execute-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .paste-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .paste-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .status-bar {
            background: rgba(30, 30, 46, 0.95);
            padding: 8px 20px;
            border-top: 1px solid rgba(99, 102, 241, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #a5b4fc;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .mode-toggle, .thinking-toggle {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            user-select: none;
            border: 1px solid transparent;
        }

        .mode-toggle:hover, .thinking-toggle:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .mode-toggle.active {
            color: #34d399;
        }

        .thinking-toggle.active {
            color: #f59e0b;
        }

        .mode-toggle.thinking-active {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.5);
            color: #fbbf24;
            animation: thinking-pulse 1.5s ease-in-out infinite;
        }

        .mode-toggle.status-highlight {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            animation: border-pulse 1.5s ease-in-out infinite;
        }

        @keyframes thinking-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes border-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

@keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .thinking-status {
            position: absolute;
            bottom: 60px;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
            z-index: 10;
        }

        .stop-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stop-button:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.05);
        }

        .thinking-text {
            color: #fbbf24;
            font-size: 13px;
            font-weight: 500;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .processing-indicator {
            color: #fbbf24;
            font-size: 13px;
            padding: 8px 12px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 4px;
            display: inline-block;
            margin-top: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .clear-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .history-container {
            margin-top: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(99, 102, 241, 0.1);
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
            font-family: 'Consolas', 'Courier New', monospace;
            color: #a5b4fc;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .history-item:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .status-bar {
            background: rgba(45, 45, 68, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #a5b4fc;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="titlebar" id="titlebar" ondblclick="toggleMaximize()">
            <div class="titlebar-title">
                <span>âš¡ FlowHub</span>
            </div>
            <div class="titlebar-controls">
                <button class="titlebar-button" onclick="window.electronAPI.minimize()">âˆ’</button>
                <button class="titlebar-button" onclick="toggleMaximize()">â–¡</button>
                <button class="titlebar-button close" onclick="window.electronAPI.close()">Ã—</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">æ–‡ä»¶æµè§ˆå™¨</div>
                    <button class="command-button" onclick="openFolder()" style="width: 100%; margin-top: 8px;">ğŸ“ æ‰“å¼€æ–‡ä»¶å¤¹</button>
                    <div id="currentFolderDisplay" style="display: none; margin-top: 12px; padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 6px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-size: 11px; color: #a5b4fc; margin-bottom: 4px;">ğŸ“‚ å½“å‰ç›®å½•</div>
                                <div id="currentFolderPath" style="font-size: 12px; color: #e0e0e0; word-break: break-all;"></div>
                            </div>
                            <div style="display: flex; gap: 6px;">
                                <button class="open-button" onclick="openCurrentFolder()" style="flex-shrink: 0; padding: 6px 10px; font-size: 11px;">ğŸ“‚ æ‰“å¼€</button>
                                <button class="copy-button" onclick="copyCurrentFolder()" style="flex-shrink: 0; padding: 6px 10px; font-size: 11px;">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="file-list" id="fileList">
                    <div style="color: #6b7280; font-size: 13px; padding: 12px; text-align: center;">
                        è¯·æ‰“å¼€æ–‡ä»¶å¤¹æŸ¥çœ‹æ–‡ä»¶
                    </div>
                </div>
                <div class="history-section">
                    <div class="sidebar-title" style="margin-top: 16px;">å‘½ä»¤å†å²</div>
                    <div class="history-container" id="historyContainer">
                        <div style="color: #6b7280; font-size: 12px; padding: 10px;">æš‚æ— å†å²è®°å½•</div>
                    </div>
                </div>

                <div class="sidebar-settings">
                    <div class="sidebar-title" style="margin-bottom: 8px;">æˆªå›¾ç®¡ç†</div>
                    <button class="sidebar-button danger" onclick="clearScreenshotFolder()">
                        ğŸ—‘ï¸ ä¸€é”®æ¸…ç†æˆªå›¾
                    </button>
                    <button class="sidebar-button settings" onclick="openSettings()" style="margin-top: 8px;">
                        âš™ï¸ è®¾ç½®
                    </button>
                </div>
            </div>

            <div class="resizer" id="leftResizer"></div>

            <div class="center-panel">
                <div class="terminal-container">
                    <div class="terminal-header">
                        <div class="terminal-title">iFlow CLI</div>
                        <div id="aiThinking" class="ai-thinking" style="display: none;">
                            â¹ AI æ€è€ƒä¸­...
                        </div>
                        <button class="clear-button" onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
                    </div>
                    <div class="terminal-output" id="terminalOutput">
                        <div class="output-line info">FlowHub - iFlow CLI å›¾å½¢åŒ–ç•Œé¢</div>
                        <div class="output-line info">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
                        <div class="output-line info">ğŸ’¡ ä½¿ç”¨æ–¹æ³•ï¼š</div>
                        <div class="output-line info">   â€¢ åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥ä½ çš„é—®é¢˜</div>
                        <div class="output-line info">   â€¢ ç‚¹å‡»"å‘é€"æŒ‰é’®æˆ–æŒ‰å›è½¦é”®</div>
                        <div class="output-line info">   â€¢ iFlow AI ä¼šå›ç­”ä½ çš„é—®é¢˜</div>
                        <div class="output-line info">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
                        <div class="output-line success">âœ“ iFlow CLI å·²å°±ç»ª (GLM-4.7)</div>
                        <div class="output-line success">âœ“ å·¥ä½œç›®å½•: E:\iflow\iflow</div>
                        <div class="output-line info">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>
                    </div>
                    <div class="status-bar" id="statusBar">
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <span id="modelInfo">GLM-4.7</span>
                        </div>
                        <span id="contextInfo">ä¸Šä¸‹æ–‡å‰©ä½™ 100%</span>
                        <span id="modeInfo" class="mode-toggle" onclick="toggleMode()" title="ç‚¹å‡»åˆ‡æ¢æ¨¡å¼ (Alt+M)">æ™ºèƒ½æ¨¡å¼</span>
                        <span id="thinkingInfo" class="thinking-toggle" onclick="toggleThinking()" title="ç‚¹å‡»åˆ‡æ¢æ€è€ƒçŠ¶æ€ (Tab)">æ€è€ƒï¼šå…³é—­</span>
                        <span id="workingDir">E:\iflow\iflow</span>
                    </div>
                    <div class="terminal-input-container">
                        <div class="terminal-input-wrapper">
                            <input type="text" class="terminal-input" id="commandInput" placeholder="è¾“å…¥å‘½ä»¤å¹¶å‘é€åˆ° iFlow CLI..." onkeypress="handleKeyPress(event)" autofocus>
                            <div class="inline-tools-right">
                                <div id="imagePreviewInline" class="image-preview-inline"></div>
                                <button class="inline-icon-button" id="imageButton" onclick="loadImage()" title="åŠ è½½å›¾ç‰‡">
                                    ğŸ“·
                                </button>
                                <button class="inline-icon-button" id="stopButton" onclick="stopThinking()" title="åœæ­¢æ€è€ƒ (ESC)">
                                    â¹
                                </button>
                            </div>
                        </div>
                        <button class="execute-button" id="executeButton" onclick="sendCommand()">
                            å‘é€
                        </button>
                    </div>
                </div>
                        </div>
                
                        <div class="right-panel">            <div class="editor-container">
                <div class="editor-header">
                    <div class="editor-title">æ–‡ä»¶ç¼–è¾‘å™¨</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="save-button" onclick="saveFile()">ğŸ’¾ ä¿å­˜</button>
                        <button class="copy-button" onclick="copyFileContent()">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                </div>
                <div class="editor-status" id="editorStatus" style="display: none;">
                    <span id="currentFileName" style="color: #e0e0e0;"></span>
                    <span id="autoSaveStatus" style="margin-left: 12px; font-size: 11px; color: #34d399; display: none;">
                        âœ“ å·²è‡ªåŠ¨ä¿å­˜
                    </span>
                </div>
                <div class="editor-wrapper">
                    <textarea class="code-editor" id="codeEditor" placeholder="é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä»¥ç¼–è¾‘..." oninput="triggerAutoSave()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminalOutput');
        const commandInput = document.getElementById('commandInput');
        const executeButton = document.getElementById('executeButton');
        const historyContainer = document.getElementById('historyContainer');
        const workingDir = document.getElementById('workingDir');

        let commandHistory = [];
        let isExecuting = false;
        let currentPrompt = 'PS E:\\iflow\\iflow>';

        // åˆ‡æ¢æœ€å¤§åŒ–/æ¢å¤çª—å£
        function toggleMaximize() {
            window.electronAPI.maximize();
        }

// åˆå§‹åŒ–åˆ†å‰²æ¡æ‹–æ‹½åŠŸèƒ½
        function initResizers() {
            const leftResizer = document.getElementById('leftResizer');
            const rightResizer = document.getElementById('rightResizer');
            const sidebar = document.querySelector('.sidebar');
            const rightPanel = document.querySelector('.right-panel');

            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!leftResizer || !sidebar) {
                console.warn('å·¦ä¾§åˆ†å‰²æ¡æˆ–ä¾§è¾¹æ å…ƒç´ ä¸å­˜åœ¨');
            }

            if (!rightResizer || !rightPanel) {
                console.warn('å³ä¾§åˆ†å‰²æ¡æˆ–å³ä¾§é¢æ¿å…ƒç´ ä¸å­˜åœ¨');
            }

            let isResizingLeft = false;
            let isResizingRight = false;

            // å·¦ä¾§åˆ†å‰²æ¡æ‹–æ‹½
            if (leftResizer) {
                leftResizer.addEventListener('mousedown', (e) => {
                    isResizingLeft = true;
                    leftResizer.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            }

            // å³ä¾§åˆ†å‰²æ¡æ‹–æ‹½
            if (rightResizer) {
                rightResizer.addEventListener('mousedown', (e) => {
                    isResizingRight = true;
                    rightResizer.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            }

            document.addEventListener('mousemove', (e) => {
                if (!isResizingLeft && !isResizingRight) return;

                const containerRect = document.querySelector('.main-content').getBoundingClientRect();

                if (isResizingLeft && sidebar) {
                    const newWidth = e.clientX - containerRect.left;
                    if (newWidth >= 200 && newWidth <= 500) {
                        sidebar.style.width = newWidth + 'px';
                    }
                }

                if (isResizingRight && rightPanel) {
                    const newWidth = containerRect.right - e.clientX;
                    if (newWidth >= 200 && newWidth <= 800) {
                        rightPanel.style.width = newWidth + 'px';
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizingLeft) {
                    isResizingLeft = false;
                    if (leftResizer) leftResizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
                if (isResizingRight) {
                    isResizingRight = false;
                    if (rightResizer) rightResizer.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // åˆå§‹åŒ–
        async function init() {
            // åˆå§‹åŒ–åˆ†å‰²æ¡æ‹–æ‹½åŠŸèƒ½
            initResizers();
            
            try {
                const dir = await window.electronAPI.getWorkingDirectory();
                if (workingDir) {
                    workingDir.textContent = dir;
                }
                currentPrompt = `PS ${dir}>`;
                
                // åˆ‡æ¢åˆ° YOLO æ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
                await switchToYOLOMode();
            } catch (error) {
                addOutput('åˆå§‹åŒ–é”™è¯¯: ' + error.message, 'error');
            }

            // ç›‘å¬å®æ—¶ç»ˆç«¯è¾“å‡º
            window.electronAPI.onTerminalOutput((data) => {
                handleTerminalOutput(data);
            });
        }

        // åˆ‡æ¢åˆ° YOLO æ¨¡å¼
        async function switchToYOLOMode() {
            try {
                currentMode = 'YOLOæ¨¡å¼';
                updateStatusBar();
            } catch (error) {
                console.error('åˆ‡æ¢åˆ° YOLO æ¨¡å¼å‡ºé”™:', error);
            }
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar(data) {
            if (data.type === 'model') {
                document.getElementById('modelInfo').textContent = data.value;
            } else if (data.type === 'context') {
                document.getElementById('contextInfo').textContent = 'ä¸Šä¸‹æ–‡å‰©ä½™ ' + data.value;
            } else if (data.type === 'cwd') {
                document.getElementById('workingDir').textContent = data.value;
            } else if (data.type === 'mode') {
                const modeInfo = document.getElementById('modeInfo');
                modeInfo.textContent = data.value;
                modeInfo.classList.add('active');
                setTimeout(() => modeInfo.classList.remove('active'), 1000);
            } else if (data.type === 'thinking') {
                const thinkingInfo = document.getElementById('thinkingInfo');
                thinkingInfo.textContent = 'æ€è€ƒï¼š' + data.value;
                thinkingInfo.classList.toggle('active', data.value === 'å¼€å¯');
            }
        }

        // é”®ç›˜å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', (e) => {
            // é˜²æ­¢æŒ‰ä½æŒ‰é”®æ—¶é‡å¤è§¦å‘
            if (e.repeat) return;

            // Alt+M åˆ‡æ¢æ¨¡å¼
            if (e.altKey && e.key === 'm') {
                e.preventDefault();
                toggleMode();
            }
            // Tab åˆ‡æ¢æ€è€ƒçŠ¶æ€
            if (e.key === 'Tab' && !e.shiftKey) {
                e.preventDefault();
                toggleThinking();
            }
            // Ctrl+Shift+M åˆ‡æ¢åˆ°é»˜è®¤æ¨¡å¼
            if (e.ctrlKey && e.shiftKey && e.key === 'M') {
                e.preventDefault();
                window.electronAPI.toggleMode('default');
            }
        });

        // å¤„ç†ç»ˆç«¯è¾“å‡º
        function handleTerminalOutput(data) {
            const outputDiv = document.createElement('div');
            outputDiv.className = 'output-line ' + (data.type === 'error' ? 'error' : data.type === 'info' ? 'info' : 'success');
            outputDiv.textContent = data.data;
            terminalOutput.appendChild(outputDiv);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // å¤„ç†å›è½¦é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendCommand();
            }
        }

        // å‘é€å‘½ä»¤åˆ°äº¤äº’å¼ç»ˆç«¯
        async function sendCommand() {
            const command = commandInput.value.trim();
            if (!command && attachedImages.length === 0) return;

            console.log('å¼€å§‹å‘é€å‘½ä»¤:', command);

            // æ˜¾ç¤ºè¾“å…¥çš„å‘½ä»¤
            const commandDiv = document.createElement('div');
            commandDiv.className = 'output-line command';
            commandDiv.textContent = '> ' + command;
            terminalOutput.appendChild(commandDiv);

            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯
            if (attachedImages.length > 0) {
                const imageInfo = document.createElement('div');
                imageInfo.className = 'output-line info';
                imageInfo.textContent = `ğŸ“· å·²é™„åŠ  ${attachedImages.length} å¼ å›¾ç‰‡`;
                terminalOutput.appendChild(imageInfo);
            }

            commandInput.value = '';
            
            // åœ¨ç»ˆç«¯é¡¶éƒ¨æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
            const aiThinking = document.getElementById('aiThinking');
            if (aiThinking) {
                aiThinking.style.display = 'flex';
            }
            
            // å¯ç”¨åœæ­¢æŒ‰é’®
            const stopButton = document.getElementById('stopButton');
            if (stopButton) {
                stopButton.classList.add('active');
            }
            
            terminalOutput.scrollTop = terminalOutput.scrollHeight;

            // æ·»åŠ åˆ°å†å²è®°å½•
            if (command) {
                addToHistory(command);
            }

            // å‘é€å‘½ä»¤åˆ°åç«¯
            try {
                console.log('è°ƒç”¨ electronAPI.sendCommand');
                const result = await window.electronAPI.sendCommand(command, attachedImages);
                console.log('æ”¶åˆ°å‘½ä»¤æ‰§è¡Œç»“æœ:', result);
                
                // æ¢å¤çŠ¶æ€æ æ˜¾ç¤º
                if (aiThinking) {
                    aiThinking.style.display = 'none';
                }
                
                if (stopButton) {
                    stopButton.classList.remove('active');
                }
                
                if (result.output && result.output.trim()) {
                    addOutput(result.output, 'success');
                }

                if (result.error && result.error.trim()) {
                    addOutput(result.error, 'error');
                }
            } catch (error) {
                console.error('å‘é€å‘½ä»¤é”™è¯¯:', error);
                addOutput('å‘é€å‘½ä»¤å¤±è´¥: ' + error.message, 'error');
                
                // æ¢å¤çŠ¶æ€æ æ˜¾ç¤º
                if (aiThinking) {
                    aiThinking.style.display = 'none';
                }
                
                if (stopButton) {
                    stopButton.classList.remove('active');
                }
            }
            
            commandInput.focus();
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // åœæ­¢æ€è€ƒ
        async function stopThinking() {
            try {
                const result = await window.electronAPI.stopThinking();
                
                // æ¢å¤çŠ¶æ€æ æ˜¾ç¤º
                const aiThinking = document.getElementById('aiThinking');
                if (aiThinking) {
                    aiThinking.style.display = 'none';
                }
                
                const stopButton = document.getElementById('stopButton');
                if (stopButton) {
                    stopButton.classList.remove('active');
                }
                
                addOutput('âœ“ å·²åœæ­¢ AI æ€è€ƒ', 'info');
            } catch (error) {
                console.error('åœæ­¢æ€è€ƒå¤±è´¥:', error);
                addOutput('åœæ­¢æ€è€ƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç›‘å¬ ESC é”®
        document.addEventListener('keydown', (event) => {
            // é˜²æ­¢æŒ‰ä½æŒ‰é”®æ—¶é‡å¤è§¦å‘
            if (event.repeat) return;

            if (event.key === 'Escape') {
                const aiThinking = document.getElementById('aiThinking');
                if (aiThinking && aiThinking.style.display === 'flex') {
                    event.preventDefault();
                    stopThinking();
                }
            }
        });

// ç²˜è´´å›¾ç‰‡
        document.addEventListener('paste', async (event) => {
            try {
                const items = event.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        event.preventDefault();
                        const blob = items[i].getAsFile();

                        // å°†blobè½¬æ¢ä¸ºbufferå¹¶ä¿å­˜åˆ°æˆªå›¾æ–‡ä»¶å¤¹
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const arrayBuffer = e.target.result;

                                // ä¿å­˜åˆ°æˆªå›¾æ–‡ä»¶å¤¹
                                const saveResult = await window.electronAPI.saveImageBufferToScreenshots(
                            arrayBuffer,
                            blob.type
                        );

                        if (saveResult.success) {
                            // è¯»å–ä¿å­˜åçš„å›¾ç‰‡
                            const imageData = await window.electronAPI.readFileAsBase64(saveResult.savedPath);
                            if (imageData.success) {
                                attachedImages.push({
                                    filePath: saveResult.savedPath,
                                    base64: imageData.content
                                });
                                updateImagePreview();
                            } else {
                                addOutput('è¯»å–å›¾ç‰‡å¤±è´¥: ' + imageData.error, 'error');
                            }
                        } else {
                            addOutput('ä¿å­˜å›¾ç‰‡å¤±è´¥: ' + saveResult.error, 'error');
                        }
                        } catch (error) {
                            console.error('ç²˜è´´å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
                            addOutput('ç²˜è´´å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(blob);
                    break;
                }
            } catch (error) {
                console.error('ç²˜è´´äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                addOutput('ç²˜è´´äº‹ä»¶å¤„ç†å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ‰§è¡Œå¿«æ·å‘½ä»¤ï¼ˆä½¿ç”¨äº¤äº’å¼ç»ˆç«¯ï¼‰
        function executeQuickCommand(command) {
            commandInput.value = command;
            sendCommand();
        }

        // æ‰“å¼€æ–‡ä»¶å¤¹
        async function openFolder() {
            try {
                const result = await window.electronAPI.openFolder();
                if (result.success) {
                    await window.electronAPI.setWorkingDirectory(result.path);
                    currentWorkingDir = result.path;
                    workingDir.textContent = result.path;
                    
                    // æ˜¾ç¤ºå½“å‰ç›®å½•
                    const currentFolderDisplay = document.getElementById('currentFolderDisplay');
                    const currentFolderPath = document.getElementById('currentFolderPath');
                    if (currentFolderDisplay && currentFolderPath) {
                        currentFolderDisplay.style.display = 'block';
                        currentFolderPath.textContent = result.path;
                    }
                    
                    // è·å–æ–‡ä»¶åˆ—è¡¨å¹¶æ˜¾ç¤ºåœ¨å·¦ä¾§
                    loadFileList(result.path);
                } else {
                    addOutput(`æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addOutput('æ‰“å¼€æ–‡ä»¶å¤¹å‡ºé”™: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶å½“å‰ç›®å½•åœ°å€
        async function copyCurrentFolder() {
            try {
                const currentFolderDisplay = document.getElementById('currentFolderDisplay');
                const currentFolderPath = document.getElementById('currentFolderPath');
                
                if (currentFolderDisplay && currentFolderPath && currentFolderPath.textContent) {
                    await navigator.clipboard.writeText(currentFolderPath.textContent);
                    addOutput('âœ“ å·²å¤åˆ¶ç›®å½•åœ°å€åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    addOutput('æ²¡æœ‰å¯å¤åˆ¶çš„ç›®å½•åœ°å€', 'error');
                }
            } catch (error) {
                addOutput('å¤åˆ¶ç›®å½•åœ°å€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰“å¼€å½“å‰ç›®å½•
        async function openCurrentFolder() {
            try {
                const currentFolderPath = document.getElementById('currentFolderPath');
                if (currentFolderPath && currentFolderPath.textContent) {
                    await window.electronAPI.openFolderInExplorer(currentFolderPath.textContent);
                    addOutput('âœ“ å·²åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æ‰“å¼€ç›®å½•', 'success');
                } else {
                    addOutput('æ²¡æœ‰å¯æ‰“å¼€çš„ç›®å½•', 'error');
                }
            } catch (error) {
                addOutput('æ‰“å¼€ç›®å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶æ–‡ä»¶å
        async function copyFileName(fileName) {
            try {
                await navigator.clipboard.writeText(fileName);
                addOutput(`âœ“ å·²å¤åˆ¶æ–‡ä»¶å: ${fileName}`, 'success');
            } catch (error) {
                addOutput('å¤åˆ¶æ–‡ä»¶åå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å›¾ç‰‡å­˜å‚¨
        let attachedImages = [];

        // åŠ è½½å›¾ç‰‡
        async function loadImage() {
            try {
                const result = await window.electronAPI.selectImage();
                if (result.success && result.filePath) {
                    // ä¿å­˜å›¾ç‰‡åˆ°æˆªå›¾æ–‡ä»¶å¤¹
                    const saveResult = await window.electronAPI.saveImageToScreenshots(result.filePath);
                    
                    if (saveResult.success) {
                        // è¯»å–ä¿å­˜åçš„å›¾ç‰‡
                        const imageData = await window.electronAPI.readFileAsBase64(saveResult.savedPath);
                        if (imageData.success) {
                            attachedImages.push({
                                filePath: saveResult.savedPath,
                                base64: imageData.content
                            });
                            updateImagePreview();
                            } else {
                            addOutput('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + imageData.error, 'error');
                        }
                    } else {
                        addOutput('ä¿å­˜å›¾ç‰‡å¤±è´¥: ' + saveResult.error, 'error');
                    }
                }
            } catch (error) {
                addOutput('åŠ è½½å›¾ç‰‡å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæˆªå›¾æ–‡ä»¶å¤¹å†…çš„å›¾ç‰‡
        async function clearScreenshots() {
            try {
                const result = await window.electronAPI.clearScreenshots();
                if (result.success) {
                    addOutput(`âœ“ å·²æ¸…ç©º ${result.count} å¼ æˆªå›¾`, 'success');
                } else {
                    addOutput('æ¸…ç©ºæˆªå›¾å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                addOutput('æ¸…ç©ºæˆªå›¾å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæˆªå›¾æ–‡ä»¶å¤¹å’Œæ–‡ä»¶å¤¹å†…çš„å›¾ç‰‡
        async function clearScreenshotFolder() {
            try {
                if (confirm('ç¡®å®šè¦åˆ é™¤æ•´ä¸ªæˆªå›¾æ–‡ä»¶å¤¹åŠå…¶å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    const result = await window.electronAPI.clearScreenshotFolder();
                    if (result.success) {
                        addOutput('âœ“ å·²åˆ é™¤æˆªå›¾æ–‡ä»¶å¤¹åŠå…¶å†…å®¹', 'success');
                    } else {
                        addOutput('åˆ é™¤æˆªå›¾æ–‡ä»¶å¤¹å¤±è´¥: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                addOutput('åˆ é™¤æˆªå›¾æ–‡ä»¶å¤¹å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ‰“å¼€è®¾ç½®
        function openSettings() {
            document.getElementById('settingsDialog').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadSettings();
        }

        // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
        function updateImagePreview() {
            const container = document.getElementById('imagePreviewInline');
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡é¢„è§ˆå®¹å™¨');
                return;
            }
            
            if (attachedImages.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = '';
            
            attachedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-inline-item';
                
                const img = document.createElement('img');
                // ç¡®ä¿base64æ ¼å¼æ­£ç¡®
                const base64Data = image.base64;
                if (base64Data.startsWith('data:')) {
                    img.src = base64Data;
                } else {
                    img.src = `data:image/jpeg;base64,${base64Data}`;
                }
                img.alt = `Image ${index + 1}`;
                
                // æ·»åŠ é”™è¯¯å¤„ç†
                img.onerror = function() {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', image.filePath);
                    console.error('base64é•¿åº¦:', base64Data.length);
                    console.error('base64å‰100å­—ç¬¦:', base64Data.substring(0, 100));
                    this.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'image-error';
                    errorDiv.style.cssText = 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#333;color:#999;font-size:10px;';
                    errorDiv.textContent = 'âœ•';
                    item.appendChild(errorDiv);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn-inline';
                deleteBtn.textContent = 'âœ•';
                deleteBtn.title = 'åˆ é™¤å›¾ç‰‡';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeImage(index);
                };
                
                item.appendChild(img);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        // åˆ é™¤å›¾ç‰‡
        function removeImage(index) {
            attachedImages.splice(index, 1);
            updateImagePreview();
            addOutput('âœ“ å·²åˆ é™¤å›¾ç‰‡', 'info');
        }

        // å½“å‰æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯
        let currentOpenFile = {
            path: null,
            name: null,
            originalContent: null
        };

        // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        let autoSaveTimer = null;
        let isAutoSaving = false;

        // æ‰“å¼€æ–‡ä»¶
        async function openFile(filePath, fileName) {
            try {
                const result = await window.electronAPI.readFile(filePath);
                if (result.success) {
                    currentOpenFile = {
                        path: filePath,
                        name: fileName,
                        originalContent: result.content
                    };

                    const codeEditor = document.getElementById('codeEditor');
                    const editorStatus = document.getElementById('editorStatus');
                    const currentFileName = document.getElementById('currentFileName');
                    const autoSaveStatus = document.getElementById('autoSaveStatus');

                    codeEditor.value = result.content;
                    editorStatus.style.display = 'block';
                    currentFileName.textContent = `ğŸ“„ ${fileName}`;
                    autoSaveStatus.style.display = 'none';

                    // æ›´æ–°æ–‡ä»¶é«˜äº®çŠ¶æ€
                    updateFileHighlight();
                } else {
                    addOutput(`æ‰“å¼€æ–‡ä»¶å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addOutput('æ‰“å¼€æ–‡ä»¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // è§¦å‘è‡ªåŠ¨ä¿å­˜
        function triggerAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            autoSaveTimer = setTimeout(async () => {
                await performAutoSave();
            }, 1000); // 1ç§’åè‡ªåŠ¨ä¿å­˜
        }

        // æ‰§è¡Œè‡ªåŠ¨ä¿å­˜
        async function performAutoSave() {
            if (!currentOpenFile.path || isAutoSaving) {
                return;
            }

            const codeEditor = document.getElementById('codeEditor');
            const currentContent = codeEditor.value;
            
            // å¦‚æœå†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œä¸ä¿å­˜
            if (currentContent === currentOpenFile.originalContent) {
                return;
            }

            isAutoSaving = true;
            
            try {
                const result = await window.electronAPI.writeFile(currentOpenFile.path, currentContent);
                if (result.success) {
                    currentOpenFile.originalContent = currentContent;
                    
                    // æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜çŠ¶æ€
                    const autoSaveStatus = document.getElementById('autoSaveStatus');
                    autoSaveStatus.style.display = 'inline';
                    
                    // 3ç§’åéšè—çŠ¶æ€æç¤º
                    setTimeout(() => {
                        autoSaveStatus.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            } finally {
                isAutoSaving = false;
            }
        }

        // ä¿å­˜æ–‡ä»¶
        async function saveFile() {
            if (!currentOpenFile.path) {
                addOutput('æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶', 'error');
                return;
            }

            try {
                const codeEditor = document.getElementById('codeEditor');
                const content = codeEditor.value;

                const result = await window.electronAPI.writeFile(currentOpenFile.path, content);
                if (result.success) {
                    currentOpenFile.originalContent = content;
                    addOutput(`âœ“ å·²ä¿å­˜æ–‡ä»¶: ${currentOpenFile.name}`, 'success');
                } else {
                    addOutput(`ä¿å­˜æ–‡ä»¶å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                addOutput('ä¿å­˜æ–‡ä»¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶æ–‡ä»¶å†…å®¹
        async function copyFileContent() {
            try {
                const codeEditor = document.getElementById('codeEditor');
                await navigator.clipboard.writeText(codeEditor.value);
                addOutput('âœ“ å·²å¤åˆ¶æ–‡ä»¶å†…å®¹åˆ°å‰ªè´´æ¿', 'success');
            } catch (error) {
                addOutput('å¤åˆ¶æ–‡ä»¶å†…å®¹å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFileList(dirPath) {
            try {
                console.log('å¼€å§‹åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œç›®å½•:', dirPath);

                // ä½¿ç”¨ PowerShell çš„ Get-ChildItem å‘½ä»¤ï¼Œå¹¶ä»¥ JSON æ ¼å¼è¾“å‡º
                // æ·»åŠ  -Depth å‚æ•°ç¡®ä¿æ­£ç¡®å¤„ç†åµŒå¥—å¯¹è±¡
                const command = `Get-ChildItem -Path "${dirPath}" -Force -ErrorAction SilentlyContinue | Select-Object Name, Mode, Length | ConvertTo-Json -Depth 10 -Compress`;
                console.log('æ‰§è¡Œå‘½ä»¤:', command);

                const result = await window.electronAPI.executeCommand(command);
                console.log('å‘½ä»¤æ‰§è¡Œç»“æœ:', result);

                if (result.success && result.output) {
                    const files = [];
                    const folders = [];

                    try {
                        // å¤„ç†ç©ºæ–‡ä»¶å¤¹çš„æƒ…å†µ
                        let jsonData;
                        try {
                            jsonData = JSON.parse(result.output);
                        } catch (e) {
                            console.error('JSON è§£æå¤±è´¥ï¼ŒåŸå§‹è¾“å‡º:', result.output);
                            // å¦‚æœ JSON è§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºæ–‡ä»¶å¤¹æˆ–å…¶ä»–é—®é¢˜
                            displayFileList([]);
                            addOutput('âœ“ æ–‡ä»¶å¤¹ä¸ºç©º', 'info');
                            return;
                        }

                        // Get-ChildItem è¿”å›çš„å¯èƒ½æ˜¯æ•°ç»„æˆ–å•ä¸ªå¯¹è±¡
                        const items = Array.isArray(jsonData) ? jsonData : (jsonData ? [jsonData] : []);

                        console.log('è§£ææ–‡ä»¶åˆ—è¡¨ï¼Œæ€»é¡¹æ•°:', items.length);

                        items.forEach(item => {
                            const name = item.Name;
                            const mode = item.Mode;

                            // PowerShell æ¨¡å¼å­—ç¬¦ä¸²ï¼š'd' å¼€å¤´è¡¨ç¤ºç›®å½•
                            const isDir = mode && mode.startsWith('d');

                            if (name) {
                                if (isDir) {
                                    folders.push({ name: name, isFolder: true });
                                } else {
                                    files.push({ name: name, isFolder: false });
                                }
                            }
                        });

                        console.log('è§£æå®Œæˆ - æ–‡ä»¶å¤¹:', folders.length, 'æ–‡ä»¶:', files.length);

                        // å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
                        displayFileList([...folders, ...files]);
                    } catch (parseError) {
                        console.error('JSON è§£æå¤±è´¥:', parseError);
                        addOutput('è§£ææ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + parseError.message, 'error');
                        console.error('åŸå§‹è¾“å‡º:', result.output);
                        // æ˜¾ç¤ºç©ºæ–‡ä»¶å¤¹æç¤º
                        displayFileList([]);
                    }
                } else {
                    // å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºæ–‡ä»¶å¤¹
                    const errorMsg = result.error || 'æœªçŸ¥é”™è¯¯';
                    console.error('åŠ è½½å¤±è´¥è¯¦æƒ…:', result);
                    // å°è¯•æ˜¾ç¤ºç©ºæ–‡ä»¶å¤¹
                    displayFileList([]);
                    addOutput('âœ“ æ–‡ä»¶å¤¹ä¸ºç©º', 'info');
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å‡ºé”™:', error);
                addOutput('åŠ è½½æ–‡ä»¶åˆ—è¡¨å‡ºé”™: ' + error.message, 'error');
                displayFileList([]);
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFileList(files) {
            const fileContainer = document.getElementById('fileList');
            if (!fileContainer) {
                console.error('æ‰¾ä¸åˆ°æ–‡ä»¶åˆ—è¡¨å®¹å™¨');
                return;
            }
            fileContainer.innerHTML = '';

            if (!files || files.length === 0) {
                fileContainer.innerHTML = '<div style="color: #6b7280; font-size: 13px; padding: 12px; text-align: center;">æ–‡ä»¶å¤¹ä¸ºç©º</div>';
                return;
            }

            // é™åˆ¶æ–‡ä»¶æ•°é‡ï¼Œé˜²æ­¢è¿‡å¤šå¯¼è‡´æ€§èƒ½é—®é¢˜
            const maxFiles = 1000;
            if (files.length > maxFiles) {
                fileContainer.innerHTML = `<div style="color: #f59e0b; font-size: 13px; padding: 12px; text-align: center;">æ–‡ä»¶æ•°é‡è¿‡å¤š (${files.length})ï¼Œä»…æ˜¾ç¤ºå‰ ${maxFiles} ä¸ª</div>`;
                files = files.slice(0, maxFiles);
            }

            // å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
            const folders = files.filter(f => f.isFolder);
            const regularFiles = files.filter(f => !f.isFolder);

            [...folders, ...regularFiles].forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.classList.add(file.isFolder ? 'folder' : 'file');

                // è®¾ç½®æ–‡ä»¶åå±æ€§ï¼Œç”¨äºé«˜äº®åŒ¹é…
                div.setAttribute('data-file-name', file.name);

                const icon = file.isFolder ? 'ğŸ“' : 'ğŸ“„';

                // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯åŒºåŸŸ
                const fileInfo = document.createElement('div');
                fileInfo.style.flex = '1';
                fileInfo.style.display = 'flex';
                fileInfo.style.alignItems = 'center';
                fileInfo.style.gap = '8px';
                fileInfo.style.overflow = 'hidden';
                fileInfo.textContent = `${icon} ${file.name}`;

                // åˆ›å»ºæ“ä½œæŒ‰é’®åŒºåŸŸ
                const actionButtons = document.createElement('div');
                actionButtons.style.display = 'flex';
                actionButtons.style.gap = '4px';
                actionButtons.style.flexShrink = '0';
                actionButtons.style.opacity = '0';
                actionButtons.style.transition = 'opacity 0.2s';

                // å¤åˆ¶æŒ‰é’®
                const copyBtn = document.createElement('button');
                copyBtn.className = 'file-action-button';
                copyBtn.style.padding = '4px 8px';
                copyBtn.style.fontSize = '11px';
                copyBtn.textContent = 'ğŸ“‹';
                copyBtn.title = 'å¤åˆ¶æ–‡ä»¶å';
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    copyFileName(file.name);
                };

                // æ‰“å¼€ç›®å½•æŒ‰é’®
                const openDirBtn = document.createElement('button');
                openDirBtn.className = 'file-action-button';
                openDirBtn.style.padding = '4px 8px';
                openDirBtn.style.fontSize = '11px';
                openDirBtn.textContent = 'ğŸ“‚';
                openDirBtn.title = 'æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ç›®å½•';
                openDirBtn.onclick = (e) => {
                    e.stopPropagation();
                    const currentFolderPath = document.getElementById('currentFolderPath');
                    if (currentFolderPath && currentFolderPath.textContent) {
                        const fullPath = `${currentFolderPath.textContent}\\${file.name}`;
                        window.electronAPI.showContextMenu(fullPath, false);
                    }
                };

                actionButtons.appendChild(copyBtn);
                actionButtons.appendChild(openDirBtn);

                div.appendChild(fileInfo);
                div.appendChild(actionButtons);

                // å•å‡»äº‹ä»¶ - å•å‡»å³å¯æ‰“å¼€æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
                div.onclick = () => {
                    const currentFolderPath = document.getElementById('currentFolderPath');
                    if (currentFolderPath && currentFolderPath.textContent) {
                        const fullPath = `${currentFolderPath.textContent}\\${file.name}`;

                        if (file.isFolder) {
                            // æ‰“å¼€æ–‡ä»¶å¤¹
                            openFolderFromPath(fullPath);
                        } else {
                            // æ‰“å¼€æ–‡ä»¶
                            openFile(fullPath, file.name);
                        }
                    }
                };

                // æ‚¬åœæ˜¾ç¤ºæŒ‰é’®
                div.onmouseenter = () => {
                    actionButtons.style.opacity = '1';
                };
                div.onmouseleave = () => {
                    actionButtons.style.opacity = '0';
                };

                // å³é”®èœå•
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    const currentFolderPath = document.getElementById('currentFolderPath');
                    if (currentFolderPath && currentFolderPath.textContent) {
                        const fullPath = `${currentFolderPath.textContent}\\${file.name}`;
                        window.electronAPI.showContextMenu(fullPath, file.isFolder);
                    }
                };

                fileContainer.appendChild(div);
            });

            // æ›´æ–°å½“å‰æ–‡ä»¶çš„é«˜äº®çŠ¶æ€
            updateFileHighlight();
        }

        // æ›´æ–°æ–‡ä»¶é«˜äº®çŠ¶æ€
        function updateFileHighlight() {
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                const fileName = item.getAttribute('data-file-name');
                if (fileName === currentOpenFile.name && !item.classList.contains('folder')) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ä»è·¯å¾„æ‰“å¼€æ–‡ä»¶å¤¹
        async function openFolderFromPath(folderPath) {
            try {
                await window.electronAPI.setWorkingDirectory(folderPath);
                currentWorkingDir = folderPath;
                workingDir.textContent = folderPath;

                // æ›´æ–°ç›®å½•æ˜¾ç¤º
                const currentFolderDisplay = document.getElementById('currentFolderDisplay');
                const currentFolderPath = document.getElementById('currentFolderPath');
                if (currentFolderDisplay && currentFolderPath) {
                    currentFolderDisplay.style.display = 'block';
                    currentFolderPath.textContent = folderPath;
                }

                // åŠ è½½æ–‡ä»¶åˆ—è¡¨
                loadFileList(folderPath);
            } catch (error) {
                addOutput('æ‰“å¼€æ–‡ä»¶å¤¹å‡ºé”™: ' + error.message, 'error');
            }
        }

// æ¨¡å¼çŠ¶æ€
        let currentMode = 'YOLOæ¨¡å¼';
        const modes = ['YOLOæ¨¡å¼', 'æ™ºèƒ½æ¨¡å¼', 'Planæ¨¡å¼', 'é»˜è®¤æ¨¡å¼'];
        let thinkingEnabled = false;

        // åˆå§‹åŒ–çŠ¶æ€æ 
        function initializeStatusBar() {
            updateStatusBar();
        }

        // åˆ‡æ¢æ¨¡å¼
        async function toggleMode() {
            try {
                // æœ¬åœ°åˆ‡æ¢æ¨¡å¼
                const currentIndex = modes.indexOf(currentMode);
                const nextIndex = (currentIndex + 1) % modes.length;
                currentMode = modes[nextIndex];
                
                updateStatusBar();
                
                // é€šçŸ¥åç«¯
                await window.electronAPI.toggleMode();
            } catch (error) {
                addOutput('åˆ‡æ¢æ¨¡å¼å‡ºé”™: ' + error.message, 'error');
            }
        }

        function updateStatusBar() {
            const modeInfo = document.getElementById('modeInfo');
            if (modeInfo) {
                modeInfo.textContent = currentMode;
                
                // é«˜äº®å½“å‰æ¨¡å¼
                modeInfo.className = 'mode-toggle active';
                setTimeout(() => {
                    modeInfo.className = 'mode-toggle';
                }, 300);
            }
        }

        // åˆ‡æ¢æ€è€ƒçŠ¶æ€
        async function toggleThinking() {
            try {
                thinkingEnabled = !thinkingEnabled;
                
                const thinkingInfo = document.getElementById('thinkingInfo');
                if (thinkingInfo) {
                    thinkingInfo.textContent = thinkingEnabled ? 'æ€è€ƒï¼šå¼€å¯' : 'æ€è€ƒï¼šå…³é—­';
                    thinkingInfo.className = thinkingEnabled ? 'thinking-toggle active' : 'thinking-toggle';
                }
                
                addOutput(`âœ“ æ€è€ƒæ¨¡å¼å·²${thinkingEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
                
                await window.electronAPI.toggleThinking();
            } catch (error) {
                addOutput('åˆ‡æ¢æ€è€ƒçŠ¶æ€å‡ºé”™: ' + error.message, 'error');
            }
        }

        // ç²˜è´´å›¾ç‰‡
        async function pasteImage() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            const reader = new FileReader();
                            
                            reader.onload = async function(e) {
                                const base64Image = e.target.result;
                                addOutput('ğŸ“· å·²ç²˜è´´å›¾ç‰‡ï¼Œæ­£åœ¨å‘é€ç»™ AI...', 'info');
                                
                                // å‘é€å›¾ç‰‡åˆ° iFlow CLI
                                await window.electronAPI.sendImageToIflow(base64Image);
                            };
                            
                            reader.readAsDataURL(blob);
                            return;
                        }
                    }
                }
                
                addOutput('âš ï¸ å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡', 'error');
            } catch (error) {
                addOutput('ç²˜è´´å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ è¾“å‡º
        function addOutput(text, type = 'info') {
            // è¿‡æ»¤æ‰ Execution Info å—
            const filteredText = text.replace(/<Execution Info>[\s\S]*?<\/Execution Info>/g, '');
            
            const lines = filteredText.split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    const div = document.createElement('div');
                    div.className = 'output-line ' + type;
                    div.textContent = line;
                    terminalOutput.appendChild(div);
                }
            });
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // æ¸…ç©ºè¾“å‡º
        function clearOutput() {
            terminalOutput.innerHTML = '<div class="output-line info">è¾“å‡ºå·²æ¸…ç©º</div>';
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(command) {
            // é¿å…é‡å¤
            if (commandHistory.includes(command)) {
                commandHistory = commandHistory.filter(cmd => cmd !== command);
            }
            commandHistory.unshift(command);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (commandHistory.length > 10) {
                commandHistory.pop();
            }

            updateHistoryDisplay();
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!historyContainer) {
                console.error('historyContainer å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (commandHistory.length === 0) {
                historyContainer.innerHTML = '<div style="color: #6b7280; font-size: 12px; padding: 10px;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            historyContainer.innerHTML = commandHistory.map(cmd => 
                `<div class="history-item" onclick="executeQuickCommand('${escapeHtml(cmd)}')">${escapeHtml(cmd)}</div>`
            ).join('');
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        executeButton.innerHTML = 'å‘é€';

        // å¯åŠ¨åˆå§‹åŒ–
        init();

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            addOutput('å‘ç”Ÿé”™è¯¯: ' + event.error.message, 'error');
        });

        // å…¨å±€æœªå¤„ç†çš„Promiseé”™è¯¯å¤„ç†
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
            addOutput('å¼‚æ­¥æ“ä½œå¤±è´¥: ' + event.reason, 'error');
        });
    </script>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsDialog" class="settings-dialog" style="display: none;">
        <div class="settings-dialog-overlay"></div>
        <div class="settings-dialog-content">
            <div class="settings-dialog-header">
                <span class="settings-dialog-title">âš¡ FlowHub è®¾ç½®</span>
                <button class="settings-dialog-close" onclick="hideSettings()">Ã—</button>
            </div>
            <div class="settings-dialog-body">
                <div class="settings-section">
                    <div class="settings-section-title">å¤–è§‚è®¾ç½®</div>
                    <div class="settings-item">
                        <label class="settings-label">å­—ä½“å¤§å°</label>
                        <select id="fontSizeSelect" class="settings-select" onchange="changeFontSize(this.value)">
                            <option value="12">å° (12px)</option>
                            <option value="14" selected>ä¸­ (14px)</option>
                            <option value="16">å¤§ (16px)</option>
                            <option value="18">ç‰¹å¤§ (18px)</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">ç•Œé¢ä¸»é¢˜</label>
                        <select id="themeSelect" class="settings-select" onchange="changeTheme(this.value)">
                            <option value="dark" selected>æ·±è‰²ä¸»é¢˜</option>
                            <option value="light">æµ…è‰²ä¸»é¢˜</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">åŠŸèƒ½è®¾ç½®</div>
                    <div class="settings-item">
                        <label class="settings-label">è‡ªåŠ¨ä¿å­˜</label>
                        <div class="settings-toggle">
                            <input type="checkbox" id="autoSaveToggle" checked onchange="toggleAutoSave(this.checked)">
                            <label for="autoSaveToggle" class="toggle-label">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">æ˜¾ç¤ºå‘½ä»¤å†å²</label>
                        <div class="settings-toggle">
                            <input type="checkbox" id="showHistoryToggle" checked onchange="toggleHistory(this.checked)">
                            <label for="showHistoryToggle" class="toggle-label">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label class="settings-label">AI æ€è€ƒåŠ¨ç”»</label>
                        <div class="settings-toggle">
                            <input type="checkbox" id="thinkingAnimationToggle" checked onchange="toggleThinkingAnimation(this.checked)">
                            <label for="thinkingAnimationToggle" class="toggle-label">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">æ•°æ®ç®¡ç†</div>
                    <button class="settings-button-secondary" onclick="clearCommandHistory()">
                        ğŸ—‘ï¸ æ¸…ç©ºå‘½ä»¤å†å²
                    </button>
                    <button class="settings-button-secondary" onclick="clearAllData()">
                        ğŸ”„ é‡ç½®æ‰€æœ‰è®¾ç½®
                    </button>
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">å…³äº</div>
                    <div class="settings-about">
                        <div class="settings-about-content">
                            <div class="settings-about-logo">
                                <img src="assets/github-logo.png" alt="GitHub" style="width: 40px; height: auto; background: transparent;">
                            </div>
                            <div class="settings-about-info">
                                <div class="settings-about-name">FlowHub</div>
                                <div class="settings-about-version">ç‰ˆæœ¬ V0.1</div>
                                <div class="settings-about-desc">iFlow CLI å›¾å½¢åŒ–ç•Œé¢</div>
                            </div>
                        </div>
                        <button class="settings-about-link" onclick="openGitHubRepo()">
                            ğŸŒ è®¿é—® GitHub ä»“åº“
                        </button>
                        <button class="settings-button-secondary" onclick="checkForUpdate()" style="margin-top: 8px;">
                            ğŸ”„ æ£€æŸ¥æ›´æ–°
                        </button>
                        <div class="settings-about-url">https://github.com/86168057/flowhub (V0.1)</div>
                    </div>
                </div>
            </div>
            <div class="settings-dialog-footer">
                <button class="settings-dialog-btn settings-dialog-btn-save" onclick="saveSettings()">
                    ğŸ’¾ ä¿å­˜è®¾ç½®
                </button>
                <button class="settings-dialog-btn settings-dialog-btn-cancel" onclick="hideSettings()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <style>
        /* è®¾ç½®å¼¹çª—æ ·å¼ */
        .settings-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .settings-dialog-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .settings-dialog-content {
            position: relative;
            width: 500px;
            min-width: 400px;
            max-width: 90vw;
            max-height: 85vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d46 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(99, 102, 241, 0.3);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .settings-dialog-header {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .settings-dialog-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-dialog-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
            line-height: 1;
        }

        .settings-dialog-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .settings-dialog-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #a5b4fc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            gap: 16px;
        }

        .settings-label {
            font-size: 14px;
            color: #e0e0e0;
            flex: 1;
        }

        .settings-select {
            flex: 1;
            max-width: 200px;
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-select:hover {
            border-color: rgba(99, 102, 241, 0.5);
        }

        .settings-select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .settings-select option {
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .settings-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: 0.3s;
            border-radius: 12px;
        }

        .toggle-label:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: #c7d2fe;
            transition: 0.3s;
            border-radius: 50%;
        }

        .settings-toggle input:checked + .toggle-label {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
        }

        .settings-toggle input:checked + .toggle-label:before {
            transform: translateX(20px);
        }

        .settings-button-secondary {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.1);
            color: #e0e0e0;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-button-secondary:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-1px);
        }

        .settings-button-secondary:last-child {
            margin-bottom: 0;
        }

        .settings-about {
            background: rgba(30, 30, 46, 0.5);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .settings-about-content {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .settings-about-logo {
            flex-shrink: 0;
        }

        .settings-about-info {
            flex: 1;
        }

        .settings-about-name {
            font-size: 16px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 4px;
        }

        .settings-about-version {
            font-size: 12px;
            color: #a5b4fc;
            margin-bottom: 4px;
        }

        .settings-about-desc {
            font-size: 13px;
            color: #9ca3af;
        }

        .settings-about-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px 12px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .settings-about-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .settings-about-url {
            margin-top: 8px;
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
            word-break: break-all;
        }

        .settings-dialog-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
            background: rgba(30, 30, 46, 0.5);
            display: flex;
            gap: 12px;
        }

        .settings-dialog-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-dialog-btn-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .settings-dialog-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .settings-dialog-btn-cancel {
            background: rgba(99, 102, 241, 0.2);
            color: #e0e0e0;
        }

        .settings-dialog-btn-cancel:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>