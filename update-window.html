<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowHub Êõ¥Êñ∞</title>
    <style>
        :root {
            --bg-primary: #1e1e2e;
            --bg-secondary: #282840;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #6366f1;
            --accent-hover: #8b5cf6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .titlebar {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            -webkit-app-region: drag;
        }

        .titlebar-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: white;
        }

        .titlebar-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }

        .titlebar-button {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .titlebar-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .content {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .version-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .version-info .current {
            color: #f59e0b;
        }

        .version-info .latest {
            color: #10b981;
            font-weight: 600;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .release-notes {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .release-notes::-webkit-scrollbar {
            width: 6px;
        }

        .release-notes::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .release-notes::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .download-info {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            display: none;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .download-info.active {
            display: block;
        }

        .download-progress {
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .download-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .download-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }

        .button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .button-secondary {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--text-primary);
        }

        .button-secondary:hover:not(:disabled) {
            background: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .button-tertiary {
            background: transparent;
            color: var(--text-secondary);
        }

        .button-tertiary:hover:not(:disabled) {
            color: var(--text-primary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <div class="titlebar-title">
            <span>‚ö° FlowHub Êõ¥Êñ∞</span>
        </div>
        <div class="titlebar-controls">
            <button class="titlebar-button" onclick="closeWindow()">√ó</button>
        </div>
    </div>

    <div class="content">
        <div class="header">
            <div class="logo">‚ö°</div>
            <div class="title">ÂèëÁé∞Êñ∞ÁâàÊú¨</div>
            <div class="version-info">
                ÂΩìÂâçÁâàÊú¨: <span class="current" id="currentVersion">V0.1</span> | 
                ÊúÄÊñ∞ÁâàÊú¨: <span class="latest" id="latestVersion">V0.2</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üìù Êõ¥Êñ∞ËØ¥Êòé</div>
            <div class="release-notes" id="releaseNotes">
                Ê≠£Âú®Âä†ËΩΩÊõ¥Êñ∞ËØ¥Êòé...
            </div>
        </div>

        <div class="section">
            <div class="download-info" id="downloadInfo">
                <div class="download-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progressText">0%</span>
                        <span id="speedText">0 KB/s</span>
                    </div>
                </div>
                <div class="download-details">
                    <span>üì¶ <span id="downloadedSize">0 MB</span> / <span id="totalSize">0 MB</span></span>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="button button-tertiary" onclick="openRepo()" id="repoButton">
                üåê ÊâìÂºÄ‰ªìÂ∫ì
            </button>
            <button class="button button-secondary" onclick="laterUpdate()" id="laterButton">
                ‚è∞ Á®çÂêéÊõ¥Êñ∞
            </button>
            <button class="button button-primary" onclick="downloadAndInstall()" id="installButton">
                üì• ‰∏ãËΩΩÂÆâË£Ö
            </button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');
        const fs = require('fs');

        let updateInfo = null;
        let isDownloading = false;

        // Êé•Êî∂Êõ¥Êñ∞‰ø°ÊÅØ
        ipcRenderer.on('update-info', (event, info) => {
            updateInfo = info;
            updateUI();
        });

        // Êé•Êî∂‰∏ãËΩΩËøõÂ∫¶
        ipcRenderer.on('download-progress', (event, progress) => {
            updateDownloadProgress(progress);
        });

        function updateUI() {
            if (!updateInfo) return;

            document.getElementById('currentVersion').textContent = `V${updateInfo.currentVersion}`;
            document.getElementById('latestVersion').textContent = `V${updateInfo.latestVersion}`;
            document.getElementById('releaseNotes').textContent = updateInfo.releaseNotes || 'ÊöÇÊó†Êõ¥Êñ∞ËØ¥Êòé';
            document.getElementById('totalSize').textContent = formatSize(updateInfo.fileSize);
        }

        function updateDownloadProgress(progress) {
            document.getElementById('progressFill').style.width = progress.percentage + '%';
            document.getElementById('progressText').textContent = progress.percentage + '%';
            document.getElementById('speedText').textContent = formatSpeed(progress.speed);
            document.getElementById('downloadedSize').textContent = formatSize(progress.current);

            if (progress.percentage >= 100) {
                // ‰∏ãËΩΩÂÆåÊàê
                document.getElementById('installButton').innerHTML = '‚úÖ ÂÆâË£ÖÂÆåÊàê';
                document.getElementById('installButton').disabled = true;
                isDownloading = false;
            }
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatSize(bytesPerSecond) + '/s';
        }

        function closeWindow() {
            window.close();
        }

        function openRepo() {
            if (updateInfo && updateInfo.releaseUrl) {
                const { shell } = require('electron');
                shell.openExternal(updateInfo.releaseUrl);
            }
        }

        function laterUpdate() {
            window.close();
        }

        async function downloadAndInstall() {
            if (!updateInfo || !updateInfo.downloadUrl || isDownloading) return;

            isDownloading = true;

            // ÊòæÁ§∫‰∏ãËΩΩ‰ø°ÊÅØ
            document.getElementById('downloadInfo').classList.add('active');
            document.getElementById('installButton').innerHTML = '<span class="spinner"></span> ‰∏ãËΩΩ‰∏≠...';
            document.getElementById('installButton').disabled = true;
            document.getElementById('repoButton').disabled = true;
            document.getElementById('laterButton').disabled = true;

            try {
                // Á°ÆÂÆö‰∏ãËΩΩË∑ØÂæÑ
                const tempDir = path.join(process.env.TEMP, 'FlowHub');
                if (!fs.existsSync(tempDir)) {
                    fs.mkdirSync(tempDir, { recursive: true });
                }

                const fileName = 'FlowHub-Setup.exe';
                const filePath = path.join(tempDir, fileName);

                // ÂºÄÂßã‰∏ãËΩΩ
                const result = await ipcRenderer.invoke('download-update', updateInfo.downloadUrl, filePath);

                if (result.success) {
                    // ‰∏ãËΩΩÊàêÂäüÔºåÂºÄÂßãÂÆâË£Ö
                    document.getElementById('installButton').innerHTML = '<span class="spinner"></span> ÂÆâË£Ö‰∏≠...';

                    const installResult = await ipcRenderer.invoke('install-update', filePath);

                    if (installResult.success) {
                        document.getElementById('installButton').innerHTML = '‚úÖ Ê≠£Âú®ÂÆâË£Ö...';
                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    } else {
                        alert('ÂÆâË£ÖÂ§±Ë¥•: ' + installResult.error);
                        resetButtons();
                    }
                } else {
                    alert('‰∏ãËΩΩÂ§±Ë¥•: ' + result.error);
                    resetButtons();
                }
            } catch (error) {
                console.error('‰∏ãËΩΩÂÆâË£ÖÂ§±Ë¥•:', error);
                alert('‰∏ãËΩΩÂÆâË£ÖÂ§±Ë¥•: ' + error.message);
                resetButtons();
            }
        }

        function resetButtons() {
            isDownloading = false;
            document.getElementById('installButton').innerHTML = 'üì• ‰∏ãËΩΩÂÆâË£Ö';
            document.getElementById('installButton').disabled = false;
            document.getElementById('repoButton').disabled = false;
            document.getElementById('laterButton').disabled = false;
        }
    </script>
</body>
</html>